---
layout: post
title: Async And Await By Example
---

<p>In <a href="http://optimizedprogrammer.com/blog/async-await-in-c-the-easy-way" target="_blank">my last post</a>, I described the async method modifier and the await operator in .NET that make it simple to write asynchronous code and promised to deliver an example showing how it works.&nbsp; This is that demonstration.</p> <p>A good way to think about using async and await is to think of a chain of phone calls for notification of some event, like a weather cancellation for an activity for youth sports.&nbsp; Ok, I know that we live in a world where this would be handled in a batch with email, SMS, and/or social media instead of a phone tree, but back in the dark ages (when I was a child), a coach or other team authority would notify a set of parents, who would notify another set, and down a chain.&nbsp; This may not be something we’d realistically face in today’s world, but it is an instructive thought exercise to illustrate asynchronous execution.</p> <p>Let’s say that we have a youth sports team and because of severe weather, a game scheduled for this evening needs to be canceled.&nbsp; Let’s construct a responsibility graph that involves chains of one person responsible for notifying another person until everyone has gotten the message.&nbsp; Let’s say we have a coach for the team named Abigail.&nbsp; Abigail is responsible for starting a notification chain and verification that notifications have been received.</p> <p><a href="http://optimizedprogrammer.com/Media/OptimizedProgrammer/Windows-Live-Writer/Async-And-Wait-By-Example_B8A7/Fotolia_66084953_Subscription_Monthly_M_2.jpg"><img title="Business man kicking a ball while calling" style="border-left-width: 0px; border-right-width: 0px; background-image: none; border-bottom-width: 0px; float: none; padding-top: 0px; padding-left: 0px; margin-left: auto; display: block; padding-right: 0px; border-top-width: 0px; margin-right: auto" border="0" alt="Business man kicking a ball while calling" src="http://optimizedprogrammer.com/Media/OptimizedProgrammer/Windows-Live-Writer/Async-And-Wait-By-Example_B8A7/Fotolia_66084953_Subscription_Monthly_M_thumb.jpg" width="324" height="484"></a></p> <p>Abigail needs to phone Ben, Bridgette, and Brock, to let them know the game is cancelled.&nbsp; Ben needs to call Clyde, Cody, and Corrine.&nbsp; Corrine calls Dan, Dennis, and Dori.</p> <p>Let us now think about what happens when Abigail makes a call (assuming the happy path):</p> <ul> <li>She first makes a connection with Ben.  <li>She informs him that there will not be a game tonight.  <li>She passes a list of the persons Ben should call.  <li>She instructs Ben to call her back upon completion of his task.</li></ul> <p>Upon receipt of the message itself and instructions for further dissemination, Ben and Abigail sever their connection.&nbsp; Ben proceeds on making his prescribed calls, while Abigail continues with the other persons for which she is responsible for communication.&nbsp; She does this by calling Bridgette and Brock in series.&nbsp; Upon hanging up with Brock, she then awaits getting calls back from the three persons she has notified.&nbsp; Upon receipt of all three returned calls, she proceeds to do something else.</p> <p>Ben does something similar.&nbsp; After hanging up with Abigail, he get Clyde on the phone and delivers the information about the cancellation of the sporting event and passes him a list of names to notify.&nbsp; Upon completion of this communication, they hang up.&nbsp; Clyde makes his calls while Ben calls Cody and Corrine.&nbsp; Upon completion of these calls, he awaits getting calls back.</p> <p>The following code is a start of a sample implementation of this (admittedly contrived) example.&nbsp; The <a href="https://github.com/raelyard/AsyncAwaitExample/" target="_blank">source repository</a> with the history of how I arrived at this code is <a href="https://github.com/raelyard/AsyncAwaitExample/" target="_blank">available on GitHub</a>.</p> <p>We start with a&nbsp; TestFixture calling the CancelPractice method on a Coach object and asserting that notification happens on each of the parents that are assigned as those that should be directly notified by the coach.</p><pre>using System;<br>using System.Threading.Tasks;<br>using NUnit.Framework;<br>using Should;<br> <br>namespace AsyncAwaitExample<br>{<br>&nbsp;&nbsp;&nbsp; [TestFixture]<br>&nbsp;&nbsp;&nbsp; public class WhenCoachCancelsPractice<br>&nbsp;&nbsp;&nbsp; {<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; private Coach _coach;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; private Parent _level1Parent0;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; private Parent _level1Parent1;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; private Parent _level1Parent2;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; private Parent _level2Parent0;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; private Parent _level2Parent1;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; private Parent _level2Parent2;<br> <br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; [SetUp]<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; public void Setup()<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; _level1Parent1 = new Parent("parent1");<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; _level1Parent2 = new Parent("parent2");<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; _level2Parent0 = new Parent("parent3");<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; _level2Parent1 = new Parent("parent4");<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; _level2Parent2 = new Parent("parent5");<br> <br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; _level1Parent0 = new Parent("parent0", _level2Parent0, _level2Parent1, _level2Parent2);<br> <br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; _coach = new Coach(_level1Parent0, _level1Parent1, _level1Parent2);<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<br> <br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; private async Task ExecuteCancelPractice()<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; await _coach.CancelPractice();<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Console.WriteLine("Coach has finished");<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<br> <br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; [Test]<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; public void ShouldNotCallLevel1Parent0WithoutCancellation()<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; AssertParentNotNotified(_level1Parent0);<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<br> <br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; [Test]<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; public void ShouldNotCallLevel1Parent1WithoutCancellation()<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; AssertParentNotNotified(_level1Parent1);<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<br> <br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; [Test]<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; public void ShouldNotCallLevel1Parent2WithoutCancellation()<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; AssertParentNotNotified(_level1Parent2);<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<br> <br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; [Test]<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; public void ShouldNotCallLevel2Parent0WithoutCancellation()<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; AssertParentNotNotified(_level2Parent0);<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<br> <br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; [Test]<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; public void ShouldNotCallLevel2Parent1WithoutCancellation()<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; AssertParentNotNotified(_level2Parent1);<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<br> <br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; [Test]<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; public void ShouldNotCallLevel2Parent2WithoutCancellation()<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; AssertParentNotNotified(_level2Parent2);<br><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<br> <br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; [Test]<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; public async Task ShouldCallLevel1Parent0()<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; await ExecuteCancelPractice();<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; AssertParentNotified(_level1Parent0);<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<br> <br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; [Test]<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; public async Task ShouldCallLevel1Parent1()<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; await ExecuteCancelPractice();<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; AssertParentNotified(_level1Parent1);<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<br> <br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; [Test]<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; public async Task ShouldCallLevel1Parent2()<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; await ExecuteCancelPractice();<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; AssertParentNotified(_level1Parent2);<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<br> <br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; [Test]<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; public async Task ShouldCallLevel2Parent0()<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; await ExecuteCancelPractice();<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; AssertParentNotified(_level2Parent0);<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<br> <br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; [Test]<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; public async Task ShouldCallLevel2Parent1()<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; await ExecuteCancelPractice();<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; AssertParentNotified(_level2Parent1);<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<br> <br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; [Test]<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; public async Task ShouldCallLevel2Parent2()<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; await ExecuteCancelPractice();<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; AssertParentNotified(_level2Parent2);<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<br> <br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; private void AssertParentNotNotified(Parent parent)<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; parent.Notified.ShouldBeFalse();<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<br> <br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; private void AssertParentNotified(Parent parent)<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; parent.Notified.ShouldBeTrue();<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<br>&nbsp;&nbsp;&nbsp; }<br>}
</pre>
<p><br></p>
<p>(Please note that the coach is level 0, so please do not comment that calling the first level of parents level 1 makes me something less than a proper nerd.)</p>
<p>This sets up a hierarchy where the parent name “parent0” is responsible for notification of three other parents.&nbsp; The tests assert that the proper notifications are being made and the console output shows the sequence.&nbsp; I could have written more tests to try to verify the proper sequence, but that would just be more code than necessary to demonstrate the point and I think this adequately communicates what we are trying to accomplish here.&nbsp; I could also refactor to get rid of the duplication of the Notify method in both the Coach and Parent Classes, but, again, this has gone far enough to demonstrate the use of async and await without any further coding.</p>
<p>And the implementation classes:</p><pre>using System;<br>using System.Linq;<br>using System.Threading.Tasks;<br> <br>namespace AsyncAwaitExample<br>{<br>&nbsp;&nbsp;&nbsp; public class Coach<br>&nbsp;&nbsp;&nbsp; {<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; private readonly Parent[] _rootNotificationParents;<br> <br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; public Coach(params Parent[] rootNotificationParents)<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; _rootNotificationParents = rootNotificationParents;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<br> <br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; public async Task CancelPractice()<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Console.WriteLine("Starting to Call parents");<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; var parentAwaitables = _rootNotificationParents.Select(parent =&gt; parent.Notify()).ToArray();<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Console.WriteLine("finished outgoing calls, waiting for calls back");<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; await Task.WhenAll(parentAwaitables);<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Console.WriteLine("Done notifying parents");<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<br>&nbsp;&nbsp;&nbsp; }<br>}
</pre>
<p>&nbsp;</p><pre>using System;<br>using System.Linq;<br>using System.Threading.Tasks;<br> <br>namespace AsyncAwaitExample<br>{<br>&nbsp;&nbsp;&nbsp; public class Parent<br>&nbsp;&nbsp;&nbsp; {<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; private readonly string _name;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; private readonly Parent[] _otherParentsForNotification;<br> <br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; public bool Notified { get; set; }<br> <br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; public Parent(string name, params Parent[] otherParentsForNotification)<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; _name = name;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; _otherParentsForNotification = otherParentsForNotification;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<br> <br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; public async virtual Task Notify()<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Console.WriteLine("{0} receiving notification", _name);<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Notified = true;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; // the phone conversation will take a finite time, so modeling that with a delay:<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; await Task.Delay(1000);<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; await NotifyOtherParents();<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Console.WriteLine("{0} done with notification, calling back notifier", _name);<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<br> <br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; private async Task NotifyOtherParents()<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Console.WriteLine("{0} Starting to Call other parents", _name);<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; var parentAwaitables = _otherParentsForNotification.Select(parent =&gt; parent.Notify()).ToArray();<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Console.WriteLine("{0} finished outgoing calls, waiting for calls back", _name);<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; await Task.WhenAll(parentAwaitables);<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Console.WriteLine("{0} Done notifying parents", _name);<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<br>&nbsp;&nbsp;&nbsp; }<br>}
</pre>
<p>&nbsp;</p>
<p>The resulting console output is this:</p>
<p>Starting to Call parents<br>parent0 receiving notification<br>parent1 receiving notification<br>parent2 receiving notification<br>finished outgoing calls, waiting for calls back<br>parent2 Starting to Call other parents<br>parent2 finished outgoing calls, waiting for calls back<br>parent2 Done notifying parents<br>parent0 Starting to Call other parents<br>parent3 receiving notification<br>parent1 Starting to Call other parents<br>parent1 finished outgoing calls, waiting for calls back<br>parent1 Done notifying parents<br>parent1 done with notification, calling back notifier<br>parent4 receiving notification<br>parent5 receiving notification<br>parent2 done with notification, calling back notifier<br>parent0 finished outgoing calls, waiting for calls back<br>parent4 Starting to Call other parents<br>parent4 finished outgoing calls, waiting for calls back<br>parent4 Done notifying parents<br>parent4 done with notification, calling back notifier<br>parent5 Starting to Call other parents<br>parent5 finished outgoing calls, waiting for calls back<br>parent5 Done notifying parents<br>parent5 done with notification, calling back notifier<br>parent3 Starting to Call other parents<br>parent3 finished outgoing calls, waiting for calls back<br>parent3 Done notifying parents<br>parent3 done with notification, calling back notifier<br>parent0 Done notifying parents<br>parent0 done with notification, calling back notifier<br>Done notifying parents<br>Coach has finished</p>
